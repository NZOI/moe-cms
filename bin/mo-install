#!/bin/bash

[ -f config ] || { echo "Missing config file, check cwd." ; exit 1 ; }
set -e
. config
make

H=`pwd`

# The eval directory
cd $MO_ROOT
rm -rf eval
mkdir eval
chgrp $EVAL_GROUP eval
chmod 755 eval
cd eval

# mo-eval home
echo "Creating $EVAL_USER"
mkdir eval
cd eval
cp -a $H/* .
chmod +x bin/*
if [ -d ~/.ssh ] ; then echo "Copying SSH configuration from ~/.ssh" ; cp -a ~/.ssh . ; fi
cd ..
chown -R $EVAL_USER.$EVAL_GROUP eval
chmod 750 eval

# testusers
( cd eval && bin/mo-create-testusers )

# mo-submit home
if [ -n "$REMOTE_SUBMIT" ] ; then
	mkdir submit
	if [ -d ~/.ssh ] ; then echo "Copying SSH configuration from ~/.ssh" ; cp -a ~/.ssh submit/ ; fi
	( cd $H && bin/mo-create-submit )
fi

# create public
cd $MO_ROOT
echo "Creating public"
rm -rf public
mkdir public

# populate public
( cd eval/eval ; bin/mo-create-public )
